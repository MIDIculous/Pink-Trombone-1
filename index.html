<html>
    <head>
        <Title>Voice</Title>
    </head>

    <body>
        <label>
            <h1 style="display: inline">Voice</h1>
            <input id=voiceToggle type="checkbox">
        </label>
        
        <hr>

        <h2>Glottis</h2>

        <label>
            <p style="display: inline">Frequency</p>
            <input type="number" id=frequencyInput data-parameter="frequency" step=1>
        </label>

        <br>

        <label>
            <p style="display: inline">Tenseness</p>
            <input type="number" id=tensenessInput data-parameter="tenseness" step=0.1>
        </label>

        <br>

        <label>
            <p style="display: inline">Intensity</p>
            <input type="number" id=intensityInput data-parameter="intensity" step=0.1>
        </label>  

        <br>

        <label>
            <p style="display: inline">Loudness</p>
            <input type="number" id=loudnessInput data-parameter="loudness" step=0.1>
        </label>

        <br>

        <label>
            <p style="display: inline">Wobble</p>
            <input type="number" id=wobbleInput data-parameter="wobble" step=0.1>
        </label>

        <hr>

        <h2>Tongue</h2>

        <label>
            <h3 style="display: inline">Presets</h3>
            <select id=tonguePresets>
                <option selected>--</option>
                <option data-diameter="2.78" data-index="14.93">æ</option>
                <option data-diameter="2.336" data-index="12.75">ɑ</option>
                <option data-diameter="2.05" data-index="12">ɒ</option>
                <option data-diameter="2.05" data-index="17.7">ɔ</option>
                <option data-diameter="2.87" data-index="26.11">ɪ</option>
                <option data-diameter="2.206" data-index="27.18">i</option>
                <option data-diameter="3.43" data-index="19.366">e</option>
                <option data-diameter="2.457" data-index="17.82">ʌ</option>
                <option data-diameter="2.05" data-index="22.79">u</option>
                <option data-diameter="2.81" data-index="20.69">ə</option>
            </select>    
        </label>
        
        <br>
        <br>

        <label>
            <p style="display: inline">Diameter</p>
            <input type="number" id=tongueDiameterInput data-parameter="diameter" step=0.1>
        </label>

        <br>

        <label>
            <p style="display: inline">Index</p>
            <input type="number" id=tongueIndexInput data-parameter="index" step=0.1>
        </label>
        
        <hr>

        <h2>Constrictions</h2>

        <label>
            <h3 style="display: inline">Presets</h3>
            <select id=constrictionPresets>
                <option selected>--</option>
                <option data-diameter="1.258" data-index="38">l</option>
                <option data-diameter="1.29" data-index="41.57">w</option>
                <option data-diameter="0.6" data-index="31.2">ʒ|ʃ</option>
                <option data-diameter="0.557" data-index="36.05">z|s</option>
                <option data-diameter="0.5397" data-index="41.329">v|f</option>
                <option data-diameter="0.537" data-index="21.48">g|k</option>
                <option data-diameter="-0.5" data-index="35.89">d|t</option>
                <option data-diameter="-0.485" data-index="41.008">b|p</option>
                <option data-diameter="-1.252" data-index="22.129">ŋ</option>
                <option data-diameter="-1.3215" data-index="35.855">n</option>
                <option data-diameter="-1.2483" data-index="40.829">m</option>
            </select>
        </label>

        <br>
        <br>

        <button id=addConstrictionButton>Add Constriction</button>

        <br>

        <ul id=constrictionsList>

            <template id=constrictionTemplate>
                <li>
                    <label>
                        <p style="display: inline">Diameter</p>
                        <input type="number" value=2.43 step=0.1 data-parameter="diameter">
                    </label>

                    <br>

                    <label>
                        <p style="display: inline">Index</p>
                        <input type="number" min=0 value=12.9 step=0.1 data-parameter="index">
                    </label>
                    
                    <br>

                    <button>remove</button>
                </li>
                <br>

            </template>

        </ul>

        <hr>
    </body>

    <script type="module">
        import Voice from "/script/Voice.js";
        import SimplexNoise from "/script/SimplexNoise.js";

        window.SimplexNoise = SimplexNoise;

        const audioContext = new AudioContext();

        if(window.AudioWorklet) {
            Promise.all([
                audioContext.audioWorklet.addModule("/script/noiseWorkletProcessor.js"),
                audioContext.audioWorklet.addModule("/script/voiceWorkletProcessor.js"),
            ]).then(() => {
                main();
            });
        }
        else {
            main();
        }

        function main() {
            const voice = new Voice(audioContext);
            window.voice = voice;

            function update() {
                update.callbacks.forEach(callback => callback());
            }
            update.callbacks = [];


            // GLOTTIS PARAMETER SETUP
            [frequencyInput, tensenessInput, intensityInput, loudnessInput, wobbleInput, tongueDiameterInput, tongueIndexInput].forEach(input => {
                const parameterName = input.dataset.parameter;
                const isTongueParameter = [tongueDiameterInput, tongueIndexInput].includes(input);
                const parameter = isTongueParameter?
                    voice.voice.params.tongue[parameterName] :
                    voice.voice.params[parameterName];

                input.min = parameter.minValue;
                input.max = parameter.maxValue;

                const updateCallback = () => {
                    const formattedValue = Math.round(parameter.value*10)/10;
                    input.value = formattedValue;
                };
                update.callbacks.push(updateCallback);
                updateCallback();

                input.addEventListener("input", () => {
                    parameter.value = Number(input.value);
                    if(isTongueParameter) {
                        voice.voice.updatePositions();
                    }
                    update();
                });
            });


            // VOICE TOGGLE
            const voiceToggleUpdateCallback = () => {
                voiceToggle.checked = (voice.voice.params.loudness.value > 0);
            }
            update.callbacks.push(voiceToggleUpdateCallback);

            voiceToggle.addEventListener("input", event => {
                if(voiceToggle.checked)
                    voice.start();
                else
                    voice.stop();

                update();
            })


            // TONGUE PRESETS
            tonguePresets.addEventListener("input", event => {
                const optionIndex = tonguePresets.selectedIndex;
                const option = tonguePresets.options[optionIndex];

                const diameter = Number(option.dataset.diameter);
                const index = Number(option.dataset.index);

                voice.voice.params.tongue.diameter.value = diameter;
                voice.voice.params.tongue.index.value = index;

                voice.voice.updatePositions();

                update();
            });


            // CONSTRICTION PRESETS
            function createConstriction(presetPosition) {
                const constrictionListItem = document.importNode(constrictionTemplate.content, true).firstElementChild;
                    const defaultPosition = {
                        diameter : 1,
                        index : 2,
                    };

                    const position = presetPosition || defaultPosition;
                    const positionIndex = voice.voice.addPosition(position);

                    const inputs = Array.from(constrictionListItem.getElementsByTagName("input"));
                    inputs.forEach(input => {
                        const parameterName = input.dataset.parameter;
                        
                        const updateCallback = () => {
                            input.value = position[parameterName];
                        };
                        updateCallback();
                        update.callbacks.push(updateCallback);

                        input.addEventListener("input", event => {
                            position[parameterName] = Number(input.value);
                            voice.voice.movePosition(positionIndex, position);
                            update();
                        });
                    });

                    const button = Array.from(constrictionListItem.getElementsByTagName("button"))[0];
                    button.addEventListener("click", event => {
                        voice.voice.removePosition(positionIndex);
                        constrictionsList.removeChild(constrictionListItem);
                    });

                constrictionsList.appendChild(constrictionListItem);
            }

            addConstrictionButton.addEventListener("click", event => {
                createConstriction();
            });

            constrictionPresets.addEventListener("input", event => {
                const optionIndex = constrictionPresets.selectedIndex;
                const option = constrictionPresets.options[optionIndex];

                const diameter = Number(option.dataset.diameter);
                const index = Number(option.dataset.index);

                const presetPosition = {
                    diameter : diameter,
                    index : index,
                };

                constrictionPresets.selectedIndex = 0;

                createConstriction(presetPosition);
            })    
        }
        

    </script>
</html>